new gweb.analytics.AutoTrack({
    profile: 'UA-5436354-2'
});

// Formbox data
var subscribeData = {
    'fields': {
        'Country': {
            'choices': [
                [
                    'AF',
                    'Afghanistan'
                ],
                [
                    'AL',
                    'Albania'
                ],
                [
                    'DZ',
                    'Algeria'
                ],
                [
                    'AS',
                    'American Samoa'
                ],
                [
                    'AD',
                    'Andorra'
                ],
                [
                    'AO',
                    'Angola'
                ],
                [
                    'AI',
                    'Anguilla'
                ],
                [
                    'AQ',
                    'Antarctica'
                ],
                [
                    'AG',
                    'Antigua and Barbuda'
                ],
                [
                    'AR',
                    'Argentina'
                ],
                [
                    'AM',
                    'Armenia'
                ],
                [
                    'AW',
                    'Aruba'
                ],
                [
                    'AC',
                    'Ascension Island'
                ],
                [
                    'AT',
                    'Austria'
                ],
                [
                    'AU',
                    'Australia'
                ],
                [
                    'AZ',
                    'Azerbaijan'
                ],
                [
                    'BS',
                    'Bahamas'
                ],
                [
                    'BH',
                    'Bahrain'
                ],
                [
                    'BD',
                    'Bangladesh'
                ],
                [
                    'BB',
                    'Barbados'
                ],
                [
                    'BY',
                    'Belarus'
                ],
                [
                    'BE',
                    'Belgium'
                ],
                [
                    'BZ',
                    'Belize'
                ],
                [
                    'BJ',
                    'Benin'
                ],
                [
                    'BM',
                    'Bermuda'
                ],
                [
                    'BT',
                    'Bhutan'
                ],
                [
                    'BO',
                    'Bolivia'
                ],
                [
                    'BA',
                    'Bosnia and Herzegovina'
                ],
                [
                    'BW',
                    'Botswana'
                ],
                [
                    'BV',
                    'Bouvet Island'
                ],
                [
                    'BR',
                    'Brazil'
                ],
                [
                    'IO',
                    'British Indian Ocean Territory'
                ],
                [
                    'VG',
                    'British Virgin Islands'
                ],
                [
                    'BN',
                    'Brunei'
                ],
                [
                    'BG',
                    'Bulgaria'
                ],
                [
                    'BF',
                    'Burkina Faso'
                ],
                [
                    'BI',
                    'Burundi'
                ],
                [
                    'KH',
                    'Cambodia'
                ],
                [
                    'CM',
                    'Cameroon'
                ],
                [
                    'CA',
                    'Canada'
                ],
                [
                    'CV',
                    'Cape Verde'
                ],
                [
                    'KY',
                    'Cayman Islands'
                ],
                [
                    'CF',
                    'Central African Republic'
                ],
                [
                    'TD',
                    'Chad'
                ],
                [
                    'CL',
                    'Chile'
                ],
                [
                    'CN',
                    'China'
                ],
                [
                    'CX',
                    'Christmas Island'
                ],
                [
                    'CC',
                    'Cocos [Keeling] Islands'
                ],
                [
                    'CO',
                    'Colombia'
                ],
                [
                    'KM',
                    'Comoros'
                ],
                [
                    'CD',
                    'Congo [DRC]'
                ],
                [
                    'CG',
                    'Congo [Republic]'
                ],
                [
                    'CK',
                    'Cook Islands'
                ],
                [
                    'CR',
                    'Costa Rica'
                ],
                [
                    'CI',
                    'C\u00f4te d\u2019Ivoire'
                ],
                [
                    'HR',
                    'Croatia'
                ],
                [
                    'CW',
                    'Cura\u00e7ao'
                ],
                [
                    'CY',
                    'Cyprus'
                ],
                [
                    'CZ',
                    'Czech Republic'
                ],
                [
                    'DK',
                    'Denmark'
                ],
                [
                    'DJ',
                    'Djibouti'
                ],
                [
                    'DM',
                    'Dominica'
                ],
                [
                    'DO',
                    'Dominican Republic'
                ],
                [
                    'EC',
                    'Ecuador'
                ],
                [
                    'EG',
                    'Egypt'
                ],
                [
                    'SV',
                    'El Salvador'
                ],
                [
                    'GQ',
                    'Equatorial Guinea'
                ],
                [
                    'ER',
                    'Eritrea'
                ],
                [
                    'EE',
                    'Estonia'
                ],
                [
                    'ET',
                    'Ethiopia'
                ],
                [
                    'FK',
                    'Falkland Islands [Islas Malvinas]'
                ],
                [
                    'FO',
                    'Faroe Islands'
                ],
                [
                    'FJ',
                    'Fiji'
                ],
                [
                    'FI',
                    'Finland'
                ],
                [
                    'FR',
                    'France'
                ],
                [
                    'GF',
                    'French Guiana'
                ],
                [
                    'PF',
                    'French Polynesia'
                ],
                [
                    'TF',
                    'French Southern Territories'
                ],
                [
                    'GA',
                    'Gabon'
                ],
                [
                    'GM',
                    'Gambia'
                ],
                [
                    'GE',
                    'Georgia'
                ],
                [
                    'DE',
                    'Germany'
                ],
                [
                    'GH',
                    'Ghana'
                ],
                [
                    'GI',
                    'Gibraltar'
                ],
                [
                    'GR',
                    'Greece'
                ],
                [
                    'GL',
                    'Greenland'
                ],
                [
                    'GD',
                    'Grenada'
                ],
                [
                    'GP',
                    'Guadeloupe'
                ],
                [
                    'GU',
                    'Guam'
                ],
                [
                    'GT',
                    'Guatemala'
                ],
                [
                    'GN',
                    'Guinea'
                ],
                [
                    'GW',
                    'Guinea-Bissau'
                ],
                [
                    'GY',
                    'Guyana'
                ],
                [
                    'HT',
                    'Haiti'
                ],
                [
                    'HM',
                    'Heard Island and McDonald Islands'
                ],
                [
                    'HN',
                    'Honduras'
                ],
                [
                    'HK',
                    'Hong Kong'
                ],
                [
                    'HU',
                    'Hungary'
                ],
                [
                    'IS',
                    'Iceland'
                ],
                [
                    'IN',
                    'India'
                ],
                [
                    'ID',
                    'Indonesia'
                ],
                [
                    'IQ',
                    'Iraq'
                ],
                [
                    'IE',
                    'Ireland'
                ],
                [
                    'IL',
                    'Israel'
                ],
                [
                    'IT',
                    'Italy'
                ],
                [
                    'JM',
                    'Jamaica'
                ],
                [
                    'JP',
                    'Japan'
                ],
                [
                    'JO',
                    'Jordan'
                ],
                [
                    'KZ',
                    'Kazakhstan'
                ],
                [
                    'KE',
                    'Kenya'
                ],
                [
                    'KI',
                    'Kiribati'
                ],
                [
                    'KW',
                    'Kuwait'
                ],
                [
                    'KG',
                    'Kyrgyzstan'
                ],
                [
                    'LA',
                    'Laos'
                ],
                [
                    'LV',
                    'Latvia'
                ],
                [
                    'LB',
                    'Lebanon'
                ],
                [
                    'LS',
                    'Lesotho'
                ],
                [
                    'LR',
                    'Liberia'
                ],
                [
                    'LY',
                    'Libya'
                ],
                [
                    'LI',
                    'Liechtenstein'
                ],
                [
                    'LT',
                    'Lithuania'
                ],
                [
                    'LU',
                    'Luxembourg'
                ],
                [
                    'MO',
                    'Macau'
                ],
                [
                    'MK',
                    'Macedonia [FYROM]'
                ],
                [
                    'MG',
                    'Madagascar'
                ],
                [
                    'MW',
                    'Malawi'
                ],
                [
                    'MY',
                    'Malaysia'
                ],
                [
                    'MV',
                    'Maldives'
                ],
                [
                    'ML',
                    'Mali'
                ],
                [
                    'MT',
                    'Malta'
                ],
                [
                    'MH',
                    'Marshall Islands'
                ],
                [
                    'MQ',
                    'Martinique'
                ],
                [
                    'MR',
                    'Mauritania'
                ],
                [
                    'MU',
                    'Mauritius'
                ],
                [
                    'YT',
                    'Mayotte'
                ],
                [
                    'MX',
                    'Mexico'
                ],
                [
                    'FM',
                    'Micronesia'
                ],
                [
                    'MD',
                    'Moldova'
                ],
                [
                    'MC',
                    'Monaco'
                ],
                [
                    'MN',
                    'Mongolia'
                ],
                [
                    'ME',
                    'Montenegro'
                ],
                [
                    'MS',
                    'Montserrat'
                ],
                [
                    'MA',
                    'Morocco'
                ],
                [
                    'MZ',
                    'Mozambique'
                ],
                [
                    'MM',
                    'Myanmar'
                ],
                [
                    'NA',
                    'Namibia'
                ],
                [
                    'NR',
                    'Nauru'
                ],
                [
                    'NP',
                    'Nepal'
                ],
                [
                    'NL',
                    'Netherlands'
                ],
                [
                    'AN',
                    'Netherlands Antilles'
                ],
                [
                    'NC',
                    'New Caledonia'
                ],
                [
                    'NZ',
                    'New Zealand'
                ],
                [
                    'NI',
                    'Nicaragua'
                ],
                [
                    'NE',
                    'Niger'
                ],
                [
                    'NG',
                    'Nigeria'
                ],
                [
                    'NU',
                    'Niue'
                ],
                [
                    'NF',
                    'Norfolk Island'
                ],
                [
                    'MP',
                    'Northern Mariana Islands'
                ],
                [
                    'NO',
                    'Norway'
                ],
                [
                    'OM',
                    'Oman'
                ],
                [
                    'PK',
                    'Pakistan'
                ],
                [
                    'PW',
                    'Palau'
                ],
                [
                    'PS',
                    'Palestine'
                ],
                [
                    'PA',
                    'Panama'
                ],
                [
                    'PG',
                    'Papua New Guinea'
                ],
                [
                    'PY',
                    'Paraguay'
                ],
                [
                    'PE',
                    'Peru'
                ],
                [
                    'PH',
                    'Philippines'
                ],
                [
                    'PN',
                    'Pitcairn Islands'
                ],
                [
                    'PL',
                    'Poland'
                ],
                [
                    'PT',
                    'Portugal'
                ],
                [
                    'PR',
                    'Puerto Rico'
                ],
                [
                    'QA',
                    'Qatar'
                ],
                [
                    'RE',
                    'R\u00e9union'
                ],
                [
                    'RO',
                    'Romania'
                ],
                [
                    'RU',
                    'Russia'
                ],
                [
                    'RW',
                    'Rwanda'
                ],
                [
                    'BL',
                    'Saint Barth\u00e9lemy'
                ],
                [
                    'SH',
                    'Saint Helena'
                ],
                [
                    'KN',
                    'Saint Kitts and Nevis'
                ],
                [
                    'LC',
                    'Saint Lucia'
                ],
                [
                    'MF',
                    'Saint Martin'
                ],
                [
                    'PM',
                    'Saint Pierre and Miquelon'
                ],
                [
                    'VC',
                    'Saint Vincent and the Grenadines'
                ],
                [
                    'WS',
                    'Samoa'
                ],
                [
                    'SM',
                    'San Marino'
                ],
                [
                    'ST',
                    'S\u00e3o Tom\u00e9 and Pr\u00edncipe'
                ],
                [
                    'SA',
                    'Saudi Arabia'
                ],
                [
                    'SN',
                    'Senegal'
                ],
                [
                    'RS',
                    'Serbia'
                ],
                [
                    'SC',
                    'Seychelles'
                ],
                [
                    'SL',
                    'Sierra Leone'
                ],
                [
                    'SG',
                    'Singapore'
                ],
                [
                    'SX',
                    'Sint Maarten'
                ],
                [
                    'SK',
                    'Slovakia'
                ],
                [
                    'SI',
                    'Slovenia'
                ],
                [
                    'SB',
                    'Solomon Islands'
                ],
                [
                    'SO',
                    'Somalia'
                ],
                [
                    'ZA',
                    'South Africa'
                ],
                [
                    'GS',
                    'South Georgia and the South Sandwich Islands'
                ],
                [
                    'KR',
                    'South Korea'
                ],
                [
                    'SS',
                    'South Sudan'
                ],
                [
                    'ES',
                    'Spain'
                ],
                [
                    'LK',
                    'Sri Lanka'
                ],
                [
                    'SD',
                    'Sudan'
                ],
                [
                    'SR',
                    'Suriname'
                ],
                [
                    'SJ',
                    'Svalbard and Jan Mayen'
                ],
                [
                    'SZ',
                    'Swaziland'
                ],
                [
                    'SE',
                    'Sweden'
                ],
                [
                    'CH',
                    'Switzerland'
                ],
                [
                    'TW',
                    'Taiwan'
                ],
                [
                    'TJ',
                    'Tajikistan'
                ],
                [
                    'TZ',
                    'Tanzania'
                ],
                [
                    'TH',
                    'Thailand'
                ],
                [
                    'TL',
                    'Timor-Leste'
                ],
                [
                    'TG',
                    'Togo'
                ],
                [
                    'TK',
                    'Tokelau'
                ],
                [
                    'TO',
                    'Tonga'
                ],
                [
                    'TT',
                    'Trinidad and Tobago'
                ],
                [
                    'TN',
                    'Tunisia'
                ],
                [
                    'TR',
                    'Turkey'
                ],
                [
                    'TM',
                    'Turkmenistan'
                ],
                [
                    'TC',
                    'Turks and Caicos Islands'
                ],
                [
                    'TV',
                    'Tuvalu'
                ],
                [
                    'UM',
                    'U.S. Outlying Islands'
                ],
                [
                    'VI',
                    'U.S. Virgin Islands'
                ],
                [
                    'UG',
                    'Uganda'
                ],
                [
                    'UA',
                    'Ukraine'
                ],
                [
                    'AE',
                    'United Arab Emirates'
                ],
                [
                    'GB',
                    'United Kingdom'
                ],
                [
                    'US',
                    'United States'
                ],
                [
                    'UY',
                    'Uruguay'
                ],
                [
                    'UZ',
                    'Uzbekistan'
                ],
                [
                    'VU',
                    'Vanuatu'
                ],
                [
                    'VA',
                    'Vatican City'
                ],
                [
                    'VE',
                    'Venezuela'
                ],
                [
                    'VN',
                    'Vietnam'
                ],
                [
                    'WF',
                    'Wallis and Futuna'
                ],
                [
                    'EH',
                    'Western Sahara'
                ],
                [
                    'YE',
                    'Yemen'
                ],
                [
                    'ZM',
                    'Zambia'
                ],
                [
                    'ZW',
                    'Zimbabwe'
                ]
            ],
            'error_messages': {
                'invalid_choice': 'Select a valid choice. %(value)s is not one of the available choices.',
                'required': 'This field is required.'
            },
            'field_type': 'Choice',
            'initial': 'United States, value=US',
            'label': 'Country',
            'required': false
        },
        'EmailAddress': {
            'error_messages': {
                'invalid': '',
                'required': 'Required'
            },
            'field_type': 'Email',
            'label': 'Email Address',
            'required': true
        },
        'ExperienceLevel': {
            'choices': [
                [
                    'Novice',
                    'Novice'
                ],
                [
                    'Intermediate',
                    'Intermediate'
                ],
                [
                    'Advanced',
                    'Advanced'
                ]
            ],
            'error_messages': {
                'invalid_choice': 'Select a valid choice. %(value)s is not one of the available choices.',
                'required': 'This field is required.'
            },
            'field_type': 'Choice',
            'label': 'Flutter experience level',
            'required': false
        },
        'FirstName': {
            'error_messages': {
                'required': 'This field is required.'
            },
            'field_type': 'Char',
            'label': 'First Name',
            'required': false,
            'widget': 'Text'
        },
        'FlutterDevUpdates': {
            'attrs': {
                'class': 'f-min',
                'value': 'True'
            },
            'error_messages': {
                'invalid': '',
                'required': 'Required'
            },
            'field_type': 'Boolean',
            'label': 'Flutter news & updates. Get the latest Flutter developer product news.',
            'required': true
        },
        'LanguagePreference': {
            'choices': [
                [
                    'en-US',
                    'English'
                ],
                [
                    'zh',
                    'Chinese (Simplified)'
                ],
                [
                    'ja',
                    'Japanese'
                ],
                [
                    'ko',
                    'Korean'
                ]
            ],
            'error_messages': {
                'invalid': '',
                'invalid_choice': 'Select a valid choice. %(value)s is not one of the available choices.',
                'required': 'Required'
            },
            'field_type': 'Choice',
            'initial': 'English, value=en-US',
            'label': 'Receive the newsletter in:',
            'required': true
        },
        'LastName': {
            'error_messages': {
                'required': 'This field is required.'
            },
            'field_type': 'Char',
            'label': 'Last Name',
            'required': false,
            'widget': 'Text'
        }
    },
    'google_analytics_account': 'UA-5436354-2',
    'url': 'https://services.google.com/fb/submissions/fluttersubscribe/'
};

var firstNameEl = document.querySelector('#first-name');
var lastNameEl = document.querySelector('#last-name');
var emailAddressEl = document.querySelector('#email-address')
var languageEl = document.querySelector('#language');
var countryEl = document.querySelector('#country');
var experienceLevelEl = document.querySelector('#experience-level');
var devUpdatesElem = document.querySelector("#sign-up")
var submitEl = document.querySelector('#submit-btn');

// Set up the country <select> element.
var countries = subscribeData.fields.Country.choices;
for (var idx in countries) {
    var c = countries[idx];
    countryEl.appendChild(new Option(c[1], c[0]));
}
countryEl.value = 'US';

// Set up the language <select> element.
var languages = subscribeData.fields.LanguagePreference.choices;
for (var idx in languages) {
    var l = languages[idx];
    languageEl.appendChild(new Option(l[1], l[0]));
}

// Set up the experience level <select> element.
var exps = subscribeData.fields.ExperienceLevel.choices;
for (var idx in exps) {
    var e = exps[idx];
    experienceLevelEl.appendChild(new Option(e[1], e[0]));
}

submitEl.disabled = true;


// Enable the submit button only when the checkbox is checked.
devUpdatesElem.addEventListener("change", function () {
    if (this.checked) {
        submitEl.disabled = false;
    } else {
        submitEl.disabled = true;
    }
});

submitEl.addEventListener("click", submitForm);

function submitForm() {
    var data = {};

    if (firstNameEl.value) {
        data.FirstName = firstNameEl.value;
    }

    if (lastNameEl.value) {
        data.LastName = lastNameEl.value;
    }

    if (emailAddressEl.value) {
        data.EmailAddress = emailAddressEl.value;
    }

    if (languageEl.value) {
        data.LanguagePreference = languageEl.value;
    }

    if (countryEl.value) {
        data.Country = countryEl.value;
    }

    if (experienceLevelEl.value) {
        data.ExperienceLevel = experienceLevelEl.value;
    }

    if (devUpdatesElem.value) {
        data.FlutterDevUpdates = devUpdatesElem.checked == true ? "true" : "false";
    }

    if (isDoubleOptIn(countryEl.value)) {
        data.FlutterDevUpdates = "unconfirmed";
    }

    sendRequest(data);
}

function isDoubleOptIn(countryCode) {
    let countries = ["AT", "DE", "GR", "LU", "NO"];
    return countries.includes(countryCode);
}

function sendRequest(data) {
    jQuery.ajax({
        url: subscribeData.url,
        type: "POST",
        headers: {
            "Content-Type": "application/x-www-form-urlencoded; charset=utf-8",
        },
        contentType: "application/x-www-form-urlencoded",
        data: data,
    })
        .done(function (data, textStatus, jqXHR) {
            if (jqXHR.status != 200) {
                throw "Unexpected HTTP status code: " + jqXHR.status;
            }
            if (data.result == "invalid" && data.errors) {
                showErrors(data.errors);
            } else {
                location.href = "/subscribe/subscribed.html";
            }
        })
        .fail(function (jqXHR, textStatus, errorThrown) {
            console.log("HTTP Request Failed");
        })
        .always(function () {
        });
}

function showErrors(errors) {
    let container = $("#error-container");
    container.empty();

    for (let formElementName in errors) {
        let errorName = errors[formElementName];
        if (errorName.length > 0 && errorName[0] == "Required") {
            console.log();
            let messageEl = document.createElement("p");

            // Limit the length of the field label name used in the error message
            let humanReadableName = subscribeData.fields[formElementName].label.substring(0, 23);

            messageEl.textContent = humanReadableName + " is required";
            container.append(messageEl);
        }
    }
}
